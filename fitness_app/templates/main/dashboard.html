{% extends "base.html" %}
{% block title %}Dashboard · Fitness App{% endblock %}
{% block content %}
<h2>Workout Plan Overview</h2>

<div style="display: flex; align-items: flex-start; gap: 32px;">
  <!-- Today's Plan Card -->
  <div style="min-width: 260px;">
    <h3>Today's Plan</h3>
    {% if today %}
      <form method="post" action="{{ url_for('main.toggle_item') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="day_id" value="{{ today.id }}">
        <ul style="list-style: none; padding: 0;">
          {% for item in today.items %}
            <li style="margin-bottom: 10px;">
              <span>
                {{ item.name }}
                {% if item.sets %}- {{ item.sets }} sets{% endif %}
                {% if item.reps %} x {{ item.reps }} reps{% endif %}
                {% if item.minutes %}- {{ item.minutes }} min{% endif %}
              </span>
              <button type="submit" name="item_index" value="{{ loop.index0 }}"
                style="margin-left: 10px;"
                {% if item.completed %}disabled{% endif %}>
                {% if item.completed %}✓{% else %}Tick{% endif %}
              </button>
            </li>
          {% endfor %}
        </ul>
      </form>
    {% else %}
      <p>No workout plan for today.</p>
    {% endif %}
  </div>

  <!-- Workout Plan Table -->
  <div style="flex: 1;">
    {% if days %}
      <table border="1" style="text-align:center;">
        <tr>
          <th>Day</th>
          {% for i in range(days[0].items|length) %}
            <th>ex {{ i+1 }}</th>
          {% endfor %}
          <th>Contribution</th>
        </tr>
        {% set max_items = days[0].items|length %}
        {% for day in days %}
          <tr>
            <td>{{ day.day_index + 1 }}</td>
            {% for item in day.items %}
              {% set color = "" %}
              {% if day.day_index == day_index %}
                {% if item.completed %} {% set color = "green" %}
                {% else %} {% set color = "orange" %}
                {% endif %}
              {% elif day.day_index < day_index %}
                {% if item.completed %} {% set color = "green" %}
                {% else %} {% set color = "red" %}
                {% endif %}
              {% else %}
                {% set color = "" %}
              {% endif %}
              <td style="color:{{ color }}">
                {{ item.name }}
              </td>
            {% endfor %}
            {# Pad with empty cells if this day has fewer items #}
            {% for i in range(max_items - day.items|length) %}
              <td></td>
            {% endfor %}
            {% set completed = day.items | selectattr('completed') | select | list | length %}
            {% set total = day.items | length %}
            {% set percent = (completed / total * 100) | round(0, 'floor') %}
            {% set lightness = 97 - (percent * 0.45) %}
            {% set contrib_color = "hsl(100, 80%, " ~ lightness|string ~ "%)" %}
            <td style="background: {{ contrib_color }};">
              {{ percent }}%
            </td>
          </tr>
        {% endfor %}
      </table>
    {% else %}
      <p>No workout plan for today. Create one <a href="{{ url_for('main.planner') }}">here</a>.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
